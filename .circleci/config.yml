# PHP CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-php/ for more details
#
version: 2
jobs:
    build:
        docker:
            # specify the version you desire here
            - image: circleci/php:7.1-browsers

            # Specify service dependencies here if necessary
            # CircleCI maintains a library of pre-built images
            # documented at https://circleci.com/docs/2.0/circleci-images/
            # - image: circleci/mysql:9.4

        working_directory: ~/repo

        steps:
            - checkout

            # Download and cache dependencies
            - restore_cache:
                keys:
                - v1-dependencies-{{ checksum "composer.lock" }}
                # fallback to using the latest cache if no exact match is found
                - v1-dependencies-

            - run: composer install -n --prefer-dist --no-dev

            - save_cache:
                paths:
                    - ./vendor
                key: v1-dependencies-{{ checksum "composer.lock" }}

    test:
            docker:
                # specify the version you desire here
                - image: circleci/php:7.1-browsers

                # Specify service dependencies here if necessary
                # CircleCI maintains a library of pre-built images
                # documented at https://circleci.com/docs/2.0/circleci-images/
                # - image: circleci/mysql:9.4

            working_directory: ~/repo

            steps:
                - checkout

                # Download and cache dependencies
                - restore_cache:
                    keys:
                    - v1-dependencies-{{ checksum "composer.lock" }}
                    # fallback to using the latest cache if no exact match is found
                    - v1-dependencies-

                - run: composer install -n --prefer-dist

                - save_cache:
                    paths:
                        - ./vendor
                    key: v1-dependencies-{{ checksum "composer.lock" }}

                # run tests!
                - test:
                  override:
                    - mkdir -p $CIRCLE_TEST_REPORTS/phpunit
                    - ./bin/phpunit --log-junit $CIRCLE_TEST_REPORTS/phpunit/junit.xml

workflows:
    version: 2
    build_and_test:
        jobs:
            - build
            - test
